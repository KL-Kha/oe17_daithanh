<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Redirect to l10n_mx_invoicing_info from address tab (if flag 'l10n_mx_show_extra_info')-->
    <template id="l10n_mx_edi_checkout" inherit_id="website_sale.checkout">
        <xpath expr="//a[hasclass('btn-primary')]" position="attributes">
            <attribute name="t-att-href">
                l10n_mx_show_extra_info and '/shop/l10n_mx_invoicing_info' or '/shop/confirm_order'
            </attribute>
        </xpath>
    </template>

    <!-- Redirect to l10n_mx_invoicing_info from the extra info tab -->
    <template id="l10n_mx_edi_extra_info" inherit_id="website_sale.extra_info">
        <xpath expr="//a[hasclass('btn-secondary')]" position="attributes">
            <attribute name="t-att-href">
                l10n_mx_show_extra_info and '/shop/l10n_mx_invoicing_info' or '/shop/checkout'
            </attribute>
        </xpath>
    </template>

    <!--
    Checkout Wizard, only add the extra_info dot if 'l10n_mx_edi_extra_info' is truthy.
    This wizard is called from the following templates:
        * cart (step 10)
        * address (step 20)
        * checkout (step 20 after address is filled)
        * extra_info (step 30)
        * payment (step 40)
    Thus, the flag 'l10n_mx_show_extra_info' needs to be passed when rendering each of them.
     -->
    <template id="wizard_checkout_inherit_l10n_mx_edi" inherit_id="website_sale.wizard_checkout">
        <xpath expr="//div[@id='wizard-step20']/parent::a" position="after">
            <t t-if="l10n_mx_show_extra_info">
                <a class="no-decoration col" t-att-href="step&gt;=25 and '/shop/l10n_mx_invoicing_info' or '#'">
                    <div id="wizard-step25"
                         t-att-class="'progress-wizard-step %s' % (step == 25 and 'active' or step&gt;25 and 'complete' or 'disabled')">
                        <div class="progress-wizard-bar d-none d-md-block"/>
                        <span class="progress-wizard-dot d-none d-md-inline-block"></span>
                        <div class="text-center progress-wizard-steplabel">Invoicing Info</div>
                    </div>
                </a>
            </t>
        </xpath>
    </template>

    <!-- Mexican Invoicing Info tab, will render the wizard with step=25 -->
    <template id="l10n_mx_edi_invoicing_info">
        <t t-call="website.layout">
            <t t-set="no_footer" t-value="1"/>
            <div id="wrap">
                <div class="container oe_website_sale py-2">
                    <div class="row">
                        <div class="col-12">
                            <t t-call="website_sale.wizard_checkout">
                                <t t-set="step" t-value="25"/>
                            </t>
                        </div>
                        <div class="col-12 col-xl-auto order-xl-2 d-none d-xl-block">
                            <t t-call="website_sale.cart_summary">
                                <t t-set="redirect" t-valuef="/shop/extra_info"/>
                            </t>
                        </div>
                        <div class="col-12 col-xl order-xl-1 oe_cart">
                            <section class="s_website_form" data-vcss="001" data-snippet="s_website_form">
                                <div class="container">
                                    <form action="/shop/l10n_mx_invoicing_info" method="post">
                                        <h2 class="o_page_header mt8">Required additional fields</h2>
                                        <div class="card">
                                            <div class="card-body">
                                                <t t-if="errors" t-foreach="errors.values()" t-as="err">
                                                    <h5 class="text-danger" t-esc="err" />
                                                </t>
                                                <div class="row">
                                                    <div class="mb-3 col-12 col-xl-6">
                                                        <p class="mb-3">Do you need an invoice?</p>
                                                        <div class="form-check d-flex flex-column">
                                                            <label class="col-form-label">
                                                                <div class="form-check">
                                                                    <input type="radio" class="form-check-input"
                                                                           name="need_invoice" value="1"
                                                                           t-att-checked="default_vals.get('need_invoice')"/>
                                                                    <div class="form-check-label"
                                                                         style="font-weight: 400">
                                                                        Yes
                                                                    </div>
                                                                </div>
                                                            </label>
                                                            <label class="col-form-label">
                                                                <div class="form-check">
                                                                    <input type="radio" class="form-check-input"
                                                                           name="need_invoice" value="0"
                                                                           t-att-checked="not default_vals.get('need_invoice')"/>
                                                                    <div class="form-check-label"
                                                                         style="font-weight: 400">
                                                                        No
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Hide the additional fields by default, unless need_invoice: 'yes' is checked -->
                                                <div class="row div_l10n_mx_edi_additional_fields"
                                                     t-att-style="default_vals.get('need_invoice') or 'display: none'">
                                                    <div t-attf-class="mb-3 #{errors.get('vat') and 'o_has_error' or ''} col-12 col-xl-7">
                                                        <label class="col-form-label" for="vat">RFC</label>
                                                        <input type="text" name="vat"
                                                               t-attf-class="form-control #{errors.get('vat') and 'is-invalid' or ''}"
                                                               t-att-value="default_vals.get('vat')"
                                                               t-att-readonly="not can_edit_vat"/>
                                                        <small t-if="not can_edit_vat" class="form-text text-muted">
                                                            Changing VAT number is not allowed once document(s) have been
                                                            issued for your account. Please contact us directly for this operation.
                                                        </small>
                                                    </div>
                                                    <t t-foreach="l10n_mx_edi_fields" t-as="field">
                                                        <t t-value="default_vals.get(field.name)" t-set="val"/>
                                                        <div class="mb-3 col-12 col-xl-7">
                                                            <t t-if="field.ttype == 'selection'">
                                                                <label class="col-form-label" t-att-for="field.name">
                                                                    <t t-out="field.field_description"/>
                                                                </label>
                                                                <select t-att-name="field.name" class="form-select">
                                                                    <option t-att-selected="not val" disabled="disabled"
                                                                            value="">
                                                                        <t t-out="'Select the %s ...' % field.field_description.lower()"/>
                                                                    </option>
                                                                    <t t-foreach="field.selection_ids" t-as="selection">
                                                                        <option t-att-selected="val and val == selection.value"
                                                                                t-att-value="selection.value">
                                                                            <t t-out="selection.name"/>
                                                                        </option>
                                                                    </t>
                                                                </select>
                                                            </t>
                                                            <t t-if="field.ttype == 'boolean'">
                                                                <div class="form-check mt-2">
                                                                    <input type="checkbox" class="form-check-input"
                                                                           t-att-id="field.name"
                                                                           t-att-name="field.name"
                                                                           t-att-checked="val"/>
                                                                    <label class="form-check-label fw-normal"
                                                                           t-att-for="field.name">
                                                                        <t t-out="field.field_description"/>
                                                                    </label>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </t>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        <div class="d-flex justify-content-between mt-3">
                                            <a role="button" href="/shop/checkout" class="btn btn-secondary mb32">
                                                <i class="oi oi-chevron-left"/>
                                                <span>Back</span>
                                            </a>
                                            <a role="button" href="#"
                                               class="btn btn-primary mb32 a-submit a-submit-disable a-submit-loading">
                                                <span>Next</span>
                                                <i class="oi oi-chevron-right"/>
                                            </a>
                                        </div>
                                    </form>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
            <div class="oe_structure" id="oe_structure_website_sale_extra_info_1"/>
        </t>
    </template>
</odoo>
